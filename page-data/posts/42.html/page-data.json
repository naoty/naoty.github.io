{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/42.html","webpackCompilationHash":"c3c2b866c676673f3ef0","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"sidekiqコンテナのヘルスチェック","time":"2018-09-28T22:41:00+0900","description":null,"tags":["aws"]},"html":"<p>ECSでsidekiqをコンテナとして実行するとき、ALBからHTTP経由でヘルスチェックができないので、Dockerのヘルスチェックを利用するといい。</p>\n<p>Dockerのヘルスチェックはシェルスクリプトで行うことができ、終了ステータスが0ならhealthy、1ならunhealthyと判断する。そこで、sidekiqのpidfileを出力するように設定し</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">test -f sidekiq.pid</code></pre></div>\n<p>でヘルスチェックすればいい。</p>\n<p>sidekiqのDockerイメージはRailsアプリケーションのものを再利用することも多いだろうから、ECSではタスク定義内のコンテナ定義で下のようにヘルスチェックを指定する。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sidekiq\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sidekiq\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"--pidfile\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./sidekiq.pid\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"healthCheck\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"command\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./sidekiq.pid\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>","fileAbsolutePath":"/home/circleci/project/contents/posts/42.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"ce25e659-5152-5dcc-a520-2e772928f1ef"}}}
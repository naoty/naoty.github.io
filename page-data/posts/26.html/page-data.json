{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/26.html","webpackCompilationHash":"299d6502817b1fc80c1d","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"RailsからReduxのinitial stateを設定する","time":"2018-03-29T23:19:00+0900","description":"コントローラーで作ったデータをReduxのinitial stateに設定できないか試してみた","tags":["rails","react"]},"html":"<div class=\"gatsby-highlight\" data-language=\"rb\"><pre class=\"language-rb\"><code class=\"language-rb\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">new</span></span>\n  <span class=\"token variable\">@user</span> <span class=\"token operator\">=</span> <span class=\"token constant\">User</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n<span class=\"token class-name\">end</span></code></pre></div>\n<p>上のようなコントローラーで作ったデータをReduxのinitial stateとして設定したいと思い、いろいろ考えて書いてみた。</p>\n<p>まず、ヘルパーとかデコレーターでモデルをReactコンポーネントに渡すpropsに変換してみる。今回はactive_decoratorを使う。</p>\n<div class=\"gatsby-highlight\" data-language=\"rb\"><pre class=\"language-rb\"><code class=\"language-rb\"><span class=\"token keyword\">module</span> <span class=\"token constant\">UserDecorator</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">to_react_props</span></span>\n    as_json<span class=\"token punctuation\">(</span>only<span class=\"token punctuation\">:</span> <span class=\"token string\">%i[first_name last_name email]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span>transform_keys <span class=\"token punctuation\">{</span> <span class=\"token operator\">|</span>key<span class=\"token operator\">|</span> key<span class=\"token punctuation\">.</span>camelcase<span class=\"token punctuation\">(</span><span class=\"token symbol\">:lower</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">.</span>transform_values <span class=\"token punctuation\">{</span> <span class=\"token operator\">|</span>value<span class=\"token operator\">|</span> value <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">.</span>to_json\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>これでモデルから必要な属性だけをcamelCaseのJSON文字列に変換できるようになった。</p>\n<p>次にRailsのviewでdata属性に上のpropsを渡す。あとでここからJSでデータを引っ張ってくる計画だ。</p>\n<div class=\"gatsby-highlight\" data-language=\"erb\"><pre class=\"language-erb\"><code class=\"language-erb\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>js-redux-root<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">data-react-props</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span><span class=\"token erb language-erb\"><span class=\"token delimiter punctuation\">&lt;%=</span> <span class=\"token variable\">@user</span><span class=\"token punctuation\">.</span>to_react_props <span class=\"token delimiter punctuation\">%></span></span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>あとは、Reduxのstoreを作成するときに上のpropsを設定する。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'DOMContentLoaded'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> rootElement <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'js-redux-root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> initialState <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>rootElement<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>reactProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>rootReducer<span class=\"token punctuation\">,</span> initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>Provider store<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>store<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>SignUpForm <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>Provider<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>これでRailsで作ったデータをReduxのinitial stateに設定できた。フォームの初期値を埋めておきたいときなど、コントローラーからReactコンポーネントにデータを渡せるとラクなので、こういう実装が必要になると思う。</p>\n<p>最近、ReactとかReduxを勉強しているので、これでいいのかよくわかりません。コードレビューお願いします。</p>","fileAbsolutePath":"/home/circleci/project/contents/posts/26.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"8f1c5fd8-1727-5926-90c8-10e5989c5d6e"}}}
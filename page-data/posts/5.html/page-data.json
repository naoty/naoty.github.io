{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/5.html","webpackCompilationHash":"18ba2da8a5335d6960c8","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"GitHub Pagesの更新をCIで自動化した","time":"2017-12-08T00:04:00+0900","description":"GitHub Pagesのための更新作業を手作業からCircleCIに変更した。","tags":["meta"]},"html":"<p>GitHub Pagesの管理が煩雑だったため、Circle CIで自動化した。</p>\n<p>これまでは<a href=\"https://github.com/naoty/naoty.github.io\">GitHub Pagesのリポジトリ</a>を<a href=\"https://github.com/naoty/homepage\">管理リポジトリ</a>のサブモジュールとして管理していたが、サブモジュールはいろいろと作業が面倒だった。サブモジュールと本体の両方をgitでコミットするのがとにかく面倒だった。</p>\n<p>最近、仕事でCircle CI 2.0の対応をしているため、このブログの更新もCIに任せることができそうだと思い、さっそく設定をした。以下、ハマったところとか工夫したところとか。</p>\n<ul>\n<li>GitHub pagesのリポジトリをcloneする必要があったが、その際にSSH接続で<code class=\"language-text\">Are you sure you want to continue connecting (yes/no)?</code>と聞かれてしまい、ビルドが止まってしまった。そこで、以下のようにすることで回避した。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> SSH settings\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> mkdir ~/.ssh/ &amp;&amp; echo <span class=\"token punctuation\">-</span>e \"Host github.com\\n\\tStrictHostKeyChecking no\\n\" <span class=\"token punctuation\">></span> ~/.ssh/config</code></pre></div>\n<ul>\n<li>Circle CIで他のリポジトリにアクセスするには鍵を追加する必要があるため、設定画面から鍵を追加した。</li>\n<li>Circle CI上でgit commitする際に<code class=\"language-text\">username/repo@commit_id</code>の記法をメッセージに追加することで、GitHub pagesのコミットメッセージから対応する管理リポジトリのコミットに辿れるようにした。</li>\n</ul>\n<p>config.ymlは今のところ以下のようになっている。<code class=\"language-text\">npm install</code>でキャッシュを使っていないけど、そこらへんは徐々に最適化していきたい。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">docker</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> circleci/node\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> SSH settings\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> mkdir ~/.ssh/ &amp;&amp; echo <span class=\"token punctuation\">-</span>e \"Host github.com\\n\\tStrictHostKeyChecking no\\n\" <span class=\"token punctuation\">></span> ~/.ssh/config\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Clone GitHub pages\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            git clone git@github.com:naoty/naoty.github.io.git .\n            git config user.email \"naoty.k@gmail.com\"\n            git config user.name \"Naoto Kaneko\"</span>\n          <span class=\"token key atrule\">working_directory</span><span class=\"token punctuation\">:</span> ~/naoty.github.io\n      <span class=\"token punctuation\">-</span> checkout\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run build\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Publish GitHub pages\n          <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            cp -pr public/* ~/naoty.github.io/\n            cd ~/naoty.github.io\n            git add .\n            git commit -m \"Publish naoty/homepage@${CIRCLE_SHA1}\"\n            git push origin master</span></code></pre></div>","fileAbsolutePath":"/home/circleci/project/contents/posts/5.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"beb8a0a7-a836-589e-8303-4ed8d114071f"}}}
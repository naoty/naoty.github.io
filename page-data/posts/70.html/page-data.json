{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/70.html","webpackCompilationHash":"c4855d3bebba2bfe9f25","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"PumaのメトリクスをDatadogに送る","time":"2019-06-30T17:18:00+0900","description":null,"tags":["rails","datadog"]},"html":"<p>普段、Datadogを使ってシステムを監視している。AWSの各サービスはCloudWatch metricsを通してDatadogから監視できるんだけど、今回はRailsアプリケーションサーバーであるPumaをDatadogから監視できるようにする。</p>\n<h1>DogStatsD</h1>\n<p>DatadogのIntegrationにPumaはないため、カスタムメトリクスを送ることになる。DogStatsDを使うと簡単にカスタムメトリクスを送ることができる。DogStatsDはdatadog-agentに同梱されており、受け取ったカスタムメトリクスをDatadogに転送する。また、<a href=\"https://github.com/statsd/statsd\">StatsD</a>と同じプロトコルを実装しているため、StatsDクライアントはDogStatsDを通してDatadogにメトリクスを送ることができる。</p>\n<h1>Pumaのメトリクス</h1>\n<p>Pumaは<code class=\"language-text\">Puma.stats</code>から以下のようなメトリクスを取得することができる。</p>\n<ul>\n<li><code class=\"language-text\">backlog</code>: スレッドによる処理を待つコネクション数</li>\n<li><code class=\"language-text\">running</code>: 実行中のスレッド数</li>\n<li><code class=\"language-text\">pool_capacity</code>: 現在サーバーが取得できるリクエスト数</li>\n<li><code class=\"language-text\">max_threads</code>: 最大スレッド数</li>\n</ul>\n<h1>puma-plugin-statsd</h1>\n<p><a href=\"https://github.com/yob/puma-plugin-statsd\">puma-plugin-statsd</a>は<code class=\"language-text\">Puma.stats</code>から取得したメトリクスをStatsDサーバーに送る。Pumaのプラグインなので、以下のように<code class=\"language-text\">config/puma.rb</code>に指定する。</p>\n<div class=\"gatsby-highlight\" data-language=\"rb\"><pre class=\"language-rb\"><code class=\"language-rb\">plugin <span class=\"token symbol\">:statsd</span></code></pre></div>\n<p>そして、起動時に環境変数<code class=\"language-text\">STATSD_HOST</code>でStatsDサーバーのホストを指定する。DogStatsDを使う場合、datadog-agentのホストを指定すればいい。</p>\n<p>これで、PumaのメトリクスがDatadogに送られるようになる。</p>","fileAbsolutePath":"/home/circleci/project/contents/posts/70.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"ed8ef4e0-f2f5-5d77-b06f-5c144503f14a"}}}
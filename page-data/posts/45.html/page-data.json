{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/45.html","webpackCompilationHash":"71cb8d3d9a1c6b9820df","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"非効率なメモ化の改善","time":"2018-10-09T22:52:00+0900","description":null,"tags":null},"html":"<p>Railsでは、よく以下のようなコードを書いたり見たりする。メモ化って言うらしい。</p>\n<div class=\"gatsby-highlight\" data-language=\"rb\"><pre class=\"language-rb\"><code class=\"language-rb\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">current_user</span></span>\n  <span class=\"token variable\">@current_user</span> <span class=\"token operator\">||</span><span class=\"token operator\">=</span> <span class=\"token constant\">User</span><span class=\"token punctuation\">.</span>find_by<span class=\"token punctuation\">(</span>cookies<span class=\"token punctuation\">.</span>signed<span class=\"token punctuation\">[</span><span class=\"token symbol\">:user_id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p><code class=\"language-text\">#current_user</code>が呼ばれるまではDBへのアクセスは発生しない。そして、アクセスした結果を<code class=\"language-text\">@current_user</code>に代入しておくことで、2回目以降の呼び出しではDBへのアクセスが発生しないようになっている。</p>\n<p>割とよく書きがちなこのコードだけど、非効率なケースがある。DBから取得した結果が<code class=\"language-text\">nil</code>のケースだ。このケースだと、<code class=\"language-text\">@current_user</code>は<code class=\"language-text\">nil</code>のままなので<code class=\"language-text\">#current_user</code>が呼び出されるたびにDBに再度アクセスすることになる。</p>\n<p>DBにアクセスした結果<code class=\"language-text\">nil</code>だとわかっているなら、2回目以降はDBにアクセスしなくていいだろう。というわけで、こんな感じで直す。</p>\n<div class=\"gatsby-highlight\" data-language=\"rb\"><pre class=\"language-rb\"><code class=\"language-rb\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">current_user</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">nil</span> <span class=\"token keyword\">if</span> <span class=\"token variable\">@current_user_exists</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">false</span>\n  <span class=\"token variable\">@current_user</span> <span class=\"token operator\">||</span><span class=\"token operator\">=</span> <span class=\"token constant\">User</span><span class=\"token punctuation\">.</span>find_by<span class=\"token punctuation\">(</span>cookies<span class=\"token punctuation\">.</span>signed<span class=\"token punctuation\">[</span><span class=\"token symbol\">:user_id</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n  <span class=\"token variable\">@current_user_exists</span> <span class=\"token operator\">||</span><span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token variable\">@current_user</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">nil</span><span class=\"token operator\">?</span>\n  <span class=\"token variable\">@current_user</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>以前のものとは見栄えが悪くなったけど、より効率的になった。もっとシンプルに書けそうな気はしている。</p>","fileAbsolutePath":"/home/circleci/project/contents/posts/45.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"7a1c11eb-0188-5b29-86d2-461caced0209"}}}
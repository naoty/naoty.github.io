{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/59.html","webpackCompilationHash":"b383bcc25e18b89a4338","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"terraformとapex infraの依存関係","time":"2019-02-28T23:52:00+0900","description":null,"tags":["terraform"]},"html":"<h1>背景</h1>\n<p>AWSの構成管理にterraformを使っているんだけど、Lambda関数とそれに関連するAWSリソースの管理は<a href=\"https://apex.run\">apex</a>を使っている。apexの方がLambda関数のバージョニングができたり、コードの依存関係を簡単にzipにまとめてアップロードできたりして便利なのだ。</p>\n<p>apexには、<code class=\"language-text\">apex infra</code>というコマンドがあり、Lambda関数にAWS関連するリソース（パーミッションとかCloudWatch Logsとか）を管理できる。実際には内部的にterraformを使っている。</p>\n<h1>課題</h1>\n<p>terraformで管理するリソースと<code class=\"language-text\">apex infra</code>で管理するリソースに明確なボーダーラインを引くことは難しい。apexで管理するLambda関数はterraformで管理するさまざまなリソースと依存関係になっていることがほとんどだからだ。どこで何が管理されているのかわからなってくる。</p>\n<h1>方針</h1>\n<p>こういうときの考え方として、依存関係の方向性を単方向にすると良かったりする。<code class=\"language-text\">apex infra</code>で管理するリソースはterraformで管理するリソースを参照することができるけど、逆にterraformで管理するリソースは<code class=\"language-text\">apex infra</code>で管理するリソースを参照できない、というルールを作る。</p>\n<h1>実装</h1>\n<p><code class=\"language-text\">apex infra</code>からterraformのリソースを参照するために<code class=\"language-text\">terraform_remote_state</code>を使う。ここでは例として、apexで管理するLambda関数をterraformで管理するSNSトピックにsubscribeしたいとする。</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">data <span class=\"token type variable\">\"terraform_remote_state\"</span></span> <span class=\"token string\">\"global\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">backend</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"s3\"</span>\n\n  <span class=\"token keyword\">config</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">region</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ap-northeast-1\"</span>\n    <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"my-terraform\"</span>\n    <span class=\"token property\">key</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"global\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_sns_topic_subscription\"</span></span> <span class=\"token string\">\"lambda\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">topic_arn</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">data</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">terraform_remote_state</span><span class=\"token punctuation\">.</span>global<span class=\"token punctuation\">.</span>my_topic<span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">protocol</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"lambda\"</span>\n  <span class=\"token property\">endpoint</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">apex_function_arns</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"my_function\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>SNSトピックのARNは事前に<code class=\"language-text\">output</code>でremote stateとして公開しておく必要がある。</p>\n<p>こうすることで、terraform側からapexで管理するLambda関数を参照せずに済んでいる。Lambda関数を参照するリソースは<code class=\"language-text\">apex infra</code>で管理し、そうでないリソースはterraformで管理するという方針でうまく整理できそうだ。</p>","fileAbsolutePath":"/home/circleci/project/contents/posts/59.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"de546ed8-420e-5791-a031-bd35e557f2b7"}}}
{"componentChunkName":"component---src-templates-post-jsx","path":"/posts/72.html","webpackCompilationHash":"d053bfff98a77f215f59","result":{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"特定のIPアドレスからのアクセスを許可する","time":"2019-07-03T23:46:00+0900","description":null,"tags":["aws","terraform"]},"html":"<p>ステージング環境などの社内だけに公開されるような環境を構築するとき、特定のIPアドレスからのアクセスを許可するセキュリティグループを作ると思う。</p>\n<p>僕はいつもこんな感じでTerraformのリソースを書く。</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">locals</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">office_ips</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"192.0.2.1\"</span>,\n    <span class=\"token string\">\"198.51.100.1\"</span>,\n    <span class=\"token string\">\"203.0.113.1\"</span>,\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group\"</span></span> <span class=\"token string\">\"office\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"office\"</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> aws_vpc.main.id\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group_rule\"</span></span> <span class=\"token string\">\"office_ingress\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">count</span> <span class=\"token punctuation\">=</span> length(local.office_ips)\n\n  <span class=\"token property\">security_group_id</span> <span class=\"token punctuation\">=</span> aws_security_group.office.id\n  <span class=\"token property\">type</span>              <span class=\"token punctuation\">=</span> <span class=\"token string\">\"ingress\"</span>\n  <span class=\"token property\">from_port</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token property\">to_port</span>           <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"-1\"</span>\n  <span class=\"token property\">cidr_blocks</span>       <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">local</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">office_ips</span><span class=\"token punctuation\">[</span><span class=\"token keyword\">count</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">index</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span>/32\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group_rule\"</span></span> <span class=\"token string\">\"office_egress\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">security_group_id</span> <span class=\"token punctuation\">=</span> aws_security_group.office.id\n  <span class=\"token property\">type</span>              <span class=\"token punctuation\">=</span> <span class=\"token string\">\"egress\"</span>\n  <span class=\"token property\">from_port</span>         <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token property\">to_port</span>           <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token property\">protocol</span>          <span class=\"token punctuation\">=</span> <span class=\"token string\">\"-1\"</span>\n  <span class=\"token property\">cidr_blocks</span>       <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>特定のIPアドレスはローカル変数でまとめておく。</li>\n<li>IPアドレスごとにインバウンドトラフィックを許可するルールを設定するため、<code class=\"language-text\">aws_security_group.ingress</code>を使わずに<code class=\"language-text\">aws_security_group_rule</code>を使う。その方が<code class=\"language-text\">count</code>を使って効率的に書ける。</li>\n<li>この書き方はNetwork ACLでも使える。</li>\n</ul>\n<p>日々のTerraform業務の中で見つけたパターンをちょっとずつブログに残していきたいと思い、1トピック1ブログの体裁で書いていくことにした。まずは、だいたい必要になるようなアクセス制限の書き方を書いてみた。次もこれくらいの粒度のブログをリズムよく書いていきたい。</p>\n<hr>\n<h2>追記：2019-07-19</h2>\n<p>terraform v0.12で導入された<a href=\"https://www.terraform.io/docs/configuration/expressions.html#dynamic-blocks\">dynamic block</a>を使うと、<code class=\"language-text\">aws_security_group_rule</code>を使う必要がないことに気づいた。</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"aws_security_group\"</span></span> <span class=\"token string\">\"office\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"office\"</span>\n  <span class=\"token property\">vpc_id</span> <span class=\"token punctuation\">=</span> aws_vpc.main.id\n\n  dynamic <span class=\"token string\">\"ingress\"</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">for_each</span> <span class=\"token punctuation\">=</span> local.office_ips\n\n    <span class=\"token keyword\">content</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n      <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n      <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"-1\"</span>\n      <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>ingress<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">}</span></span>/32\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">egress</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">from_port</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token property\">to_port</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token property\">protocol</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"-1\"</span>\n    <span class=\"token property\">cidr_blocks</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"0.0.0.0/0\"</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fileAbsolutePath":"/home/circleci/project/contents/posts/72.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"853382ae-96e3-5412-aeb7-32bd663a8c7e"}}}
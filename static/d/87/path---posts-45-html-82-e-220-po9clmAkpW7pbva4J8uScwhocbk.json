{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"非効率なメモ化の改善","time":"2018-10-09T22:52:00+0900","description":null,"tags":null},"html":"<p>Railsでは、よく以下のようなコードを書いたり見たりする。メモ化って言うらしい。</p>\n<pre><code class=\"language-rb\">def current_user\n  @current_user ||= User.find_by(cookies.signed[:user_id])\nend\n</code></pre>\n<p><code>#current_user</code>が呼ばれるまではDBへのアクセスは発生しない。そして、アクセスした結果を<code>@current_user</code>に代入しておくことで、2回目以降の呼び出しではDBへのアクセスが発生しないようになっている。</p>\n<p>割とよく書きがちなこのコードだけど、非効率なケースがある。DBから取得した結果が<code>nil</code>のケースだ。このケースだと、<code>@current_user</code>は<code>nil</code>のままなので<code>#current_user</code>が呼び出されるたびにDBに再度アクセスすることになる。</p>\n<p>DBにアクセスした結果<code>nil</code>だとわかっているなら、2回目以降はDBにアクセスしなくていいだろう。というわけで、こんな感じで直す。</p>\n<pre><code class=\"language-rb\">def current_user\n  return nil if @current_user_exists == false\n  @current_user ||= User.find_by(cookies.signed[:user_id])\n  @current_user_exists ||= !@current_user.nil?\n  @current_user\nend\n</code></pre>\n<p>以前のものとは見栄えが悪くなったけど、より効率的になった。もっとシンプルに書けそうな気はしている。</p>","fileAbsolutePath":"/home/circleci/project/contents/posts/45.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"7a1c11eb-0188-5b29-86d2-461caced0209"}}
{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"Terraformの実行環境","time":"2018-12-02T11:41:00+0900","description":null,"tags":["terraform","docker"]},"html":"<p>Terraformを実行する方法としては、Homebrew等でインストールしてローカルで実行する方法と、<a href=\"https://hub.docker.com/r/hashicorp/terraform/\">hashicorp/terraform</a>のDockerイメージを使って実行する方法がある。</p>\n<h1>Dockerイメージ</h1>\n<p>Dockerイメージを使うことで実行するTerraformのバージョンをチームで統一することができる。また、CIでTerraformを簡単に実行できるようになるので、Dockerイメージを使うようにしている。</p>\n<p><a href=\"https://hub.docker.com/r/hashicorp/terraform/\">hashicorp/terraform</a>を使うときにはベースイメージとして使い、ソースコードを<code>ADD</code>したDockerイメージを作っている。<code>ENTRYPOINT</code>が<code>terraform</code>に設定されているため、以下のようにしてデフォルトでシェルにログインできるようにしている。</p>\n<pre><code>FROM hashicorp/terraform:0.11.10\nWORKDIR /terraform\nADD . /terraform/\nENTRYPOINT [\"\"]\nCMD [\"/bin/sh\"]\n</code></pre>\n<p><code>CMD</code>では<code>/bin/sh</code>の前に<code>terraform init</code>をしておくようなスクリプトを使うとより便利になると思う。</p>\n<h1>複数環境</h1>\n<p>本番環境やステージング環境といった環境ごとにtfstateを管理し環境間で共用するモジュールがある場合、以下のようなディレクトリ構成になると思う。</p>\n<pre><code>.\n├── modules\n│   └── some_module\n├── production\n│   ├── main.tf\n│   └── terraform.tfstate\n└── staging\n    ├── main.tf\n    └── terraform.tfstate\n</code></pre>\n<p>こういった場合、環境ごとにDockerfileを用意するようにしている。</p>\n<pre><code>FROM hashicorp/terraform:0.11.10\nWORKDIR /terraform/production\n\nADD ./production /terraform/production\nADD ./modules /terraform/modules\nRUN terraform get\n\nENTRYPOINT [\"\"]\nCMD [\"/bin/sh\"]\n</code></pre>\n<p>モジュールを利用するため<code>terraform get</code>でモジュールを初期化した状態でDockerイメージをビルドする。ビルドする際には以下のようにDockerfileの場所とコンテキストを分けて指定する。</p>\n<pre><code>$ docker build -t my-terraform:production -f ./production/Dockerfile .\n</code></pre>\n<p>環境ごとにDockerfileを用意する場合、docker-composeを使うとより簡単に管理できる。</p>\n<pre><code>version: \"3\"\nservices:\n  production:\n    build:\n      context: .\n      dockerfile: ./production/Dockerfile\n    image: my-terraform:production\n    volumes:\n      - ./production:/terraform/production\n      - ./modules:/terraform/modules\n  staging:\n    build:\n      context: .\n      dockerfile: ./staging/Dockerfile\n    image: my-terraform:staging\n    volumes:\n      - ./staging:/terraform/staging\n      - ./modules:/terraform/modules\n</code></pre>\n<p>これですべての環境のDockerイメージを簡単にビルドできる。</p>\n<pre><code>$ docker-compose build\n</code></pre>\n<p>Terraformを実行するときは環境を指定してDockerイメージを起動すればいい。</p>\n<pre><code>$ docker-compose run --rm production\n</code></pre>","fileAbsolutePath":"/home/circleci/project/contents/posts/49.md"}},"pageContext":{"id":"793704b1-9902-57ae-873d-6c67a469fc47"}}
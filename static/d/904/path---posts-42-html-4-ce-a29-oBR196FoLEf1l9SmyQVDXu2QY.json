{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"sidekiqコンテナのヘルスチェック","time":"2018-09-28T22:41:00+0900","description":null,"tags":["aws"]},"html":"<p>ECSでsidekiqをコンテナとして実行するとき、ALBからHTTP経由でヘルスチェックができないので、Dockerのヘルスチェックを利用するといい。</p>\n<p>Dockerのヘルスチェックはシェルスクリプトで行うことができ、終了ステータスが0ならhealthy、1ならunhealthyと判断する。そこで、sidekiqのpidfileを出力するように設定し</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">test -f sidekiq.pid</code></pre></div>\n<p>でヘルスチェックすればいい。</p>\n<p>sidekiqのDockerイメージはRailsアプリケーションのものを再利用することも多いだろうから、ECSではタスク定義内のコンテナ定義で下のようにヘルスチェックを指定する。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[\n  {\n    &quot;name&quot;: &quot;sidekiq&quot;,\n    &quot;command&quot;: [&quot;sidekiq&quot;, &quot;--pidfile&quot;, &quot;./sidekiq.pid&quot;],\n    &quot;healthCheck&quot;: {\n      &quot;command&quot;: [&quot;test&quot;, &quot;-f&quot;, &quot;./sidekiq.pid&quot;]\n    }\n  }\n]</code></pre></div>","fileAbsolutePath":"/home/circleci/project/contents/posts/42.md"}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"ce25e659-5152-5dcc-a520-2e772928f1ef"}}
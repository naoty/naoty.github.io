{"data":{"site":{"siteMetadata":{"rootURL":"https://naoty.github.io"}},"markdownRemark":{"frontmatter":{"title":"ヘルスチェックのエンドポイントを分ける","time":"2019-03-05T20:45:00+0900","description":null,"tags":["rails"]},"html":"<h1>課題</h1>\n<p>ヘルスチェックによってWebアプリケーションが依存するDBなどのサービスの健康状態もチェックすると、Webアプリケーションが正常であっても依存するサービスが異常である限りヘルスチェックが失敗することになり、サービス全体に影響が出てしまう。また、ECSでは、ヘルスチェックが失敗したコンテナは再起動することになるため、依存するサービスが失敗している限り、コンテナが何度も再起動してしまう。</p>\n<p>一方で、Webアプリケーションが依存するサービスと正常に接続しているかどうかを確認するには、依存するサービスも合わせてヘルスチェックするしかない。外形監視サービスを使う場合、DBなど外部から直接アクセスできないサービスの状態を確認するにはWebアプリケーションを経由するしかない。</p>\n<h1>方針</h1>\n<p>ロードバランサー用のエンドポイントと外形監視用のエンドポイントを分ける。</p>\n<p>ロードバランサー用のエンドポイントでは、Webアプリケーションの健康状態のみを返すようにする。外形監視用のエンドポイントは依存するサービスも合わせてシステム全体の健康状態を返すようにする。</p>\n<h1>実装</h1>\n<p>Railsアプリの場合、<a href=\"https://github.com/sportngin/okcomputer\">okcomputer</a>というrubygemが使いやすい。</p>\n<pre><code>gem \"okcomputer\"\n</code></pre>\n<p>gemをインストールするだけでエンドポイントが2つ定義される。<code>GET /okcomputer</code>でRailsアプリの健康状態だけを返す。このエンドポイントをロードバランサー用のヘルスチェックに使う。</p>\n<pre><code>$ curl http://localhost:3000/okcomputer\ndefault: PASSED Application is running (0s)\n</code></pre>\n<p>また、<code>GET /okcomputer/all</code>で依存するサービスの状態も含めて返す。カスタマイズすることで、Redisなど他のサービスもヘルスチェックできる。こちらのエンドポイントを外形監視用のヘルスチェックに使う。</p>\n<pre><code>$ curl http://localhost:3000/okcomputer/all\nDefault Collection\n  database: PASSED Schema version: 20190101000000 (0s)\n  default: PASSED Application is running (0s)\n</code></pre>","fileAbsolutePath":"/home/circleci/project/contents/posts/61.md"}},"pageContext":{"id":"07d4d0e8-fd08-53ae-9cb1-4d2699692ada"}}